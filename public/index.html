<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bridge Keeper - Magic Link Auth</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        font-size: 28px;
        margin-bottom: 10px;
        color: #333;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input[type='email'],
      input[type='text'] {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type='email']:focus,
      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        width: 100%;
        padding: 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background: #5568d3;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        display: block;
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        font-size: 14px;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .user-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }

      .user-info.show {
        display: block;
      }

      .user-info p {
        margin: 8px 0;
        color: #333;
        font-size: 14px;
      }

      .user-info strong {
        color: #667eea;
      }

      .logout-btn {
        background: #dc3545;
        margin-top: 10px;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      .divider {
        margin: 30px 0;
        text-align: center;
        color: #999;
        font-size: 14px;
      }

      .links {
        margin-top: 20px;
        text-align: center;
        font-size: 12px;
      }

      .links a {
        color: #667eea;
        text-decoration: none;
        margin: 0 5px;
      }

      .links a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Bridge Keeper</h1>
      <p class="subtitle">Magic Link Authentication</p>

      <div id="message" class="message"></div>
      <div id="loadingSpinner" class="loading">
        <span class="spinner"></span>
        <span id="loadingText">Processing...</span>
      </div>

      <!-- Login Form -->
      <div id="loginSection">
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input
              type="email"
              id="email"
              placeholder="you@example.com"
              required
              autocomplete="email"
            />
          </div>
          <button type="submit">Send Magic Link</button>
        </form>

        <div class="divider">or</div>

        <button id="testValidateBtn" style="background: #28a745">Test Validate Session</button>

        <div class="links">
          <a href="http://localhost:3000/docs" target="_blank">üìö API Docs</a>
          <a
            href="#"
            onclick="
              showDevInfo();
              return false;
            "
            >üîç Dev Info</a
          >
        </div>
      </div>

      <!-- User Info Section -->
      <div id="userInfoSection" class="user-info">
        <p><strong>User ID:</strong> <span id="userId"></span></p>
        <p><strong>Email:</strong> <span id="userEmail"></span></p>
        <p><strong>Session:</strong> <span id="userSession"></span></p>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <script>
      // Determine API base URL - use the current domain for the API
      const API_BASE_URL = window.location.origin;

      // Your Stytch domain (used for logging)
      const STYTCH_DOMAIN = 'https://candle-emperor-0880.customers.stytch.dev';

      // Check if we're in the magic link callback
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      if (token) {
        handleMagicLink(token);
      } else {
        checkExistingSession();
      }

      // Check for existing session
      async function checkExistingSession() {
        const sessionToken = localStorage.getItem('sessionToken');
        if (sessionToken) {
          await validateSession();
        }
      }

      // Handle magic link from email
      async function handleMagicLink(token) {
        showLoading('Authenticating...');
        showMessage('', 'info');

        try {
          const response = await fetch(`${API_BASE_URL}/auth/authenticate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              token: token,
              type: 'magic_link',
            }),
            credentials: 'include',
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Authentication failed');
          }

          // Store session token and user ID
          localStorage.setItem('sessionToken', data.sessionToken);
          localStorage.setItem('userId', data.userId);
          showMessage('‚úÖ Authentication successful! Loading your info...', 'success');

          // Wait a moment then fetch user info
          setTimeout(() => {
            validateSession();
          }, 1000);

          // Clean up URL
          window.history.replaceState({}, document.title, window.location.pathname);
        } catch (error) {
          console.error('Magic link error:', error);
          showMessage(`‚ùå ${error.message}`, 'error');
          hideLoading();
        }
      }

      // Validate session and get user info
      async function validateSession() {
        showLoading('Validating session...');

        try {
          const response = await fetch(`${API_BASE_URL}/auth/validate`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${localStorage.getItem('sessionToken')}`,
            },
            credentials: 'include',
          });

          if (!response.ok) {
            localStorage.removeItem('sessionToken');
            throw new Error('Session invalid');
          }

          // Session is valid, now get user info
          await getUserInfo();
        } catch (error) {
          console.error('Validation error:', error);
          showMessage(`‚ùå ${error.message}`, 'error');
          hideLoading();
        }
      }

      // Get user information
      async function getUserInfo() {
        try {
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${localStorage.getItem('sessionToken')}`,
            },
            credentials: 'include',
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Failed to fetch user info');
          }

          // Display user info
          document.getElementById('userId').textContent = data.userId || 'N/A';
          document.getElementById('userEmail').textContent = data.email || 'N/A';
          document.getElementById('userSession').textContent = '‚úÖ Active';

          // Toggle sections
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('userInfoSection').classList.add('show');

          showMessage('‚úÖ Welcome! You are logged in.', 'success');
          hideLoading();
        } catch (error) {
          console.error('User info error:', error);
          showMessage(`‚ùå ${error.message}`, 'error');
          hideLoading();
        }
      }

      // Handle login form submission
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('email').value;
        showLoading('Sending magic link...');
        showMessage('', 'info');

        try {
          const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: email,
            }),
            credentials: 'include',
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Failed to send magic link');
          }

          showMessage(
            `‚úÖ Magic link sent! Check your email at ${email}.<br><small>Click the link in your email to authenticate.</small>`,
            'success',
          );
          document.getElementById('email').value = '';
        } catch (error) {
          console.error('Login error:', error);
          showMessage(`‚ùå ${error.message}`, 'error');
        } finally {
          hideLoading();
        }
      });

      // Test validate session button
      document.getElementById('testValidateBtn').addEventListener('click', async () => {
        showLoading('Testing validate endpoint...');
        showMessage('', 'info');

        try {
          const response = await fetch(`${API_BASE_URL}/auth/validate`, {
            method: 'GET',
            credentials: 'include',
          });

          const data = await response.json();
          console.log('Validation response:', data);

          if (response.ok) {
            showMessage('‚úÖ Session is valid!', 'success');
            if (data.userId) {
              await getUserInfo();
            }
          } else {
            showMessage('‚ùå No active session. Please login first.', 'error');
          }
        } catch (error) {
          console.error('Validation error:', error);
          showMessage(`‚ùå ${error.message}`, 'error');
        } finally {
          hideLoading();
        }
      });

      // Logout function
      function logout() {
        fetch(`${API_BASE_URL}/auth/logout`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${localStorage.getItem('sessionToken')}`,
          },
          credentials: 'include',
        }).finally(() => {
          localStorage.removeItem('sessionToken');
          document.getElementById('userInfoSection').classList.remove('show');
          document.getElementById('loginSection').style.display = 'block';
          showMessage('‚úÖ Logged out successfully.', 'success');
        });
      }

      // Helper functions
      function showMessage(text, type) {
        const msg = document.getElementById('message');
        msg.innerHTML = text;
        msg.className = `message ${type}`;
      }

      function showLoading(text) {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingSpinner').style.display = 'block';
      }

      function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
      }

      function showDevInfo() {
        const info = {
          apiBase: API_BASE_URL,
          sessionToken: localStorage.getItem('sessionToken') || 'None',
          timestamp: new Date().toISOString(),
        };
        alert('Dev Info:\n' + JSON.stringify(info, null, 2));
      }
    </script>
  </body>
</html>
